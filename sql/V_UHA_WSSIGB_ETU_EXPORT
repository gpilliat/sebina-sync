-- Source : APOGEE (Oracle 19c)
-- Destination : PostgreSQL EXPORT_ETU
-- Rôle : Extraction de la scolarité active pour le projet SEBINA

CREATE OR REPLACE VIEW PASSCAMPUS.V_UHA_WSSIGB_ETU_EXPORT (
    LAST_NAME, BIRTH_NAME, FIRST_NAME, GENDER, BIRTH_PLACE, BIRTH_DATE, 
    STREET_FULL_ANNUAL, COMP_1_ANNUAL, COMP_2_ANNUAL, ZIP_CODE_ANNUAL, FOREIGN_LABEL_ANNUAL, CITY_ANNUAL, COUNTRY_CODE_ANNUAL, COUNTRY_ANNUAL, 
    PHONE_ANNUAL, MOBILE_ANNUAL, 
    STREET_FULL_PERMANENT, COMP_1_PERMANENT, COMP_2_PERMANENT, ZIP_CODE_PERMANENT, FOREIGN_LABEL_PERMANENT, CITY_PERMANENT, COUNTRY_CODE_PERMANENT, COUNTRY_PERMANENT, 
    PHONE_PERMANENT, MOBILE_PERMANENT, 
    TYPE_CARTE, ID_OPAQUE, INE_CODE, PRIMARY_AFFILIATION, ESTABLISHMENT, 
    ACADEMIC_LEVEL, AREA_FORMATION_CYCLE, DEGREE_SHORT_LABEL, INSTITUTE_SHORT_LABEL, SISE_DISCIPLINE, SISE_DOMAIN, 
    LIBRARY_REGISTRATION_FEE, PAYMENT_DATE, LAST_REGISTRATION_YEAR, ETU_NUMBER, UPDATE_DATE, AREA_CODE, DEGREE_CODE
) AS
SELECT DISTINCT
    VUE1.NOMUSUEL AS LAST_NAME,
    VUE1.PATRONYME AS BIRTH_NAME,
    VUE1.PRENOM AS FIRST_NAME,
    CASE VUE1.CIV
        WHEN 'M.' THEN 'M'
        WHEN 'Mme' THEN 'F'
        WHEN 'Mlle' THEN 'M'
        ELSE ''
    END AS GENDER,
    VUE1.VILLENAISSANCE AS BIRTH_PLACE,
    TO_CHAR (VUE1.DATENAISS, 'YYYY-MM-DD') AS BIRTH_DATE,
    -- Adresse Annuelle
    VUE1.ADRSCOL2 AS STREET_FULL_ANNUAL,
    VUE1.ADRSCOL1 AS COMP_1_ANNUAL,
    VUE1.ADRSCOL3 AS COMP_2_ANNUAL,
    VUE1.ADRSCOLCP AS ZIP_CODE_ANNUAL,
    VUE1.ADRSCOLCOMPLEMENT AS FOREIGN_LABEL_ANNUAL,
    VUE1.ADRSCOLCOMMUNE AS CITY_ANNUAL,
    VUE1.ADRSCOLPAYSCODE AS COUNTRY_CODE_ANNUAL,
    VUE1.ADRSCOLPAYSLIB AS COUNTRY_ANNUAL,
    VUE1.TELEPHONESCOL AS PHONE_ANNUAL,
    VUE1.TELEPHONEPORTABLESCOL AS MOBILE_ANNUAL,
    -- Adresse Permanente
    VUE1.ADRPERM2 AS STREET_FULL_PERMANENT,
    VUE1.ADRPERM1 AS COMP_1_PERMANENT,
    '' AS COMP_2_PERMANENT,
    VUE1.ADRPERMCP AS ZIP_CODE_PERMANENT,
    VUE1.ADRPERMCOMPLEMENT AS FOREIGN_LABEL_PERMANENT,
    VUE1.ADRPERMCOMMUNE AS CITY_PERMANENT,
    VUE1.ADRPERMPAYSCODE AS COUNTRY_CODE_PERMANENT,
    VUE1.ADRPERMPAYSLIB AS COUNTRY_PERMANENT,
    VUE1.TELEPHONEPERM AS PHONE_PERMANENT,
    VUE1.TELEPHONEPORTABLEPERM AS MOBILE_PERMANENT,
    'UHA' AS TYPE_CARTE,
    VUE1.CODEETU AS ID_OPAQUE,
    VUE1.CODENNE AS INE_CODE,
    'Student' AS PRIMARY_AFFILIATION,
    'UHA' AS ESTABLISHMENT,
    -- Mapping des niveaux académiques (L1->1, M1->4, etc.)
    CASE VUE1.NIVEAU
        WHEN 'L1' THEN '1' WHEN 'L2' THEN '2' WHEN 'L3' THEN '3'
        WHEN 'M1' THEN '4' WHEN 'M2' THEN '5'
        WHEN 'D1' THEN '6' WHEN 'D2' THEN '7' WHEN 'D3' THEN '8'
        ELSE '?'
    END AS ACADEMIC_LEVEL,
    -- Mapping des cycles (L, M, D -> 1, 2, 3)
    CASE SUBSTR (VUE1.NIVEAU, 1, 1)
        WHEN 'D' THEN '3' WHEN 'M' THEN '2' WHEN 'L' THEN '1'
        ELSE '?'
    END AS AREA_FORMATION_CYCLE,
    VUE1.DIPLOMELIBELLE AS DEGREE_SHORT_LABEL,
    VUE1.UFR AS INSTITUTE_SHORT_LABEL,
    VUE1.DOMAINECODE AS SISE_DISCIPLINE,
    VUE1.DOMAINELIBELLE AS SISE_DOMAIN,
    'DU' AS LIBRARY_REGISTRATION_FEE, -- Droits Universitaires
    '' AS PAYMENT_DATE,
    VUE1.ANNEE AS LAST_REGISTRATION_YEAR,
    TO_CHAR (VUE1.CODEETU) AS ETU_NUMBER,
    TO_CHAR (SYSDATE, 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS UPDATE_DATE,
    VUE1.ETAPECODE AS AREA_CODE,
    VUE1.DIPLOMECODE AS DEGREE_CODE
FROM PASSCAMPUS.V_UHA_WSSIG_ETUD_SRC VUE1;
